name: Build ZMK user config (patched for single entry)

on:
  workflow_call:
    inputs:
      board:
        required: false
        type: string
      shield:
        required: false
        type: string
      keymap:
        required: false
        type: string
      format:
        required: false
        type: string
      build_matrix_path:
        required: false
        type: string
      config_path:
        required: true
        type: string

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          echo "::group::Preparing build matrix"
          if [[ -n "${{ inputs.board }}" && -n "${{ inputs.shield }}" ]]; then
            echo "Using single firmware build from inputs..."
            echo "::set-output name=matrix::[{\"board\":\"${{ inputs.board }}\",\"shield\":\"${{ inputs.shield }}\",\"keymap\":\"${{ inputs.keymap || 'default' }}\",\"format\":\"${{ inputs.format || 'bt' }}\"}]"
          elif [[ -n "${{ inputs.build_matrix_path }}" ]]; then
            echo "Using build matrix from path: ${{ inputs.build_matrix_path }}"
            matrix=$(yq eval '.include' "${{ inputs.build_matrix_path }}" | jq -c .)
            echo "::set-output name=matrix::$matrix"
          else
            echo "::error::No board/shield inputs or build_matrix_path provided"
            exit 1
          fi
          echo "::endgroup::"

  build:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Cache Zephyr build system
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache
            ~/.west
            .west
            build
            zephyr/.zephyr
            modules
          key: zephyr-${{ runner.os }}-${{ matrix.board }}-${{ matrix.shield }}-${{ matrix.keymap }}-${{ matrix.format }}
          restore-keys: |
            zephyr-${{ runner.os }}-

      - name: Install west and dependencies
        run: |
          pip install west
          west init -l config
          west update
          west zephyr-export
          pip install -r config/zephyr/scripts/requirements.txt

      - name: Build firmware
        run: |
          west build -s config -d build \
            -b ${{ matrix.board }} \
            -- -DSHIELD=${{ matrix.shield }} \
               -DCONF_FILE=prj.${{ matrix.format }}.conf

      - name: Package firmware
        run: |
          mkdir -p artifact
          cp build/zephyr/zmk.uf2 artifact/${{ matrix.board }}_${{ matrix.shield }}_${{ matrix.keymap }}_${{ matrix.format }}.uf2

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.board }}_${{ matrix.shield }}_${{ matrix.keymap }}_${{ matrix.format }}
          path: artifact/