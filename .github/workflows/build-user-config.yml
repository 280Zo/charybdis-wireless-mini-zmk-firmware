name: Build ZMK user config (patched from upstream)

on:
  workflow_call:
    inputs:
      board:
        required: false
        type: string
      shield:
        required: false
        type: string
      keymap:
        required: false
        type: string
      format:
        required: false
        type: string
      build_matrix_path:
        required: false
        type: string
      config_path:
        required: true
        type: string

jobs:
  set-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - name: Set build matrix
        id: set
        run: |
          echo "::group::Preparing build matrix"
          if [[ -n "${{ inputs.board }}" && -n "${{ inputs.shield }}" ]]; then
            echo "Single entry mode: using provided inputs."
            matrix='[{"board":"${{ inputs.board }}","shield":"${{ inputs.shield }}","keymap":"${{ inputs.keymap || 'default' }}","format":"${{ inputs.format || 'bt' }}"}]'
            echo "::set-output name=matrix::$matrix"
          elif [[ -n "${{ inputs.build_matrix_path }}" ]]; then
            echo "Matrix mode: reading from ${{ inputs.build_matrix_path }}"
            matrix=$(yq eval '.include' "${{ inputs.build_matrix_path }}" | jq -c .)
            echo "::set-output name=matrix::$matrix"
          else
            echo "::error::No board/shield inputs or build_matrix_path provided"
            exit 1
          fi
          echo "::endgroup::"

  checkout_config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout user config
        uses: actions/checkout@v4
        with:
          path: config

  checkout_zmk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ZMK
        uses: actions/checkout@v4
        with:
          repository: zmkfirmware/zmk
          ref: main
          path: zmk

  build:
    needs: [set-matrix, checkout_config, checkout_zmk]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJson(needs.set-matrix.outputs.matrix) }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Install west and dependencies
        run: |
          pip install west
          west init -l config
          west update
          west zephyr-export
          pip install -r zmk/zephyr/scripts/requirements.txt

      - name: Cache Zephyr modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache
            ~/.west
            .west
            build
            zephyr/.zephyr
            modules
          key: zephyr-${{ runner.os }}-${{ matrix.board }}-${{ matrix.shield }}-${{ matrix.keymap }}-${{ matrix.format }}
          restore-keys: |
            zephyr-${{ runner.os }}-

      - name: Build firmware
        run: |
          west build -s config -d build \
            -b ${{ matrix.board }} \
            -- -DSHIELD=${{ matrix.shield }} \
               -DCONF_FILE=prj.${{ matrix.format }}.conf

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.board }}_${{ matrix.shield }}_${{ matrix.keymap }}_${{ matrix.format }}
          path: build/zephyr/zmk.uf2
