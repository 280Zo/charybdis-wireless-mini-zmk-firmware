name: Build and Merge Keymaps

on: [push, pull_request, workflow_dispatch]

jobs:
  create-qwerty-keymap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Add any dependencies here

      - name: Generate QWERTY keymap
        run: |
          python scripts/generate_qwerty.py

  matrix:
    runs-on: ubuntu-latest
    env:
      build_matrix_path: "build.yaml"
    name: Fetch Build Keyboards
    outputs:
      build_matrix: ${{ env.build_matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yaml2json
        run: python3 -m pip install remarshal

      - name: Fetch Build Matrix
        run: |
          echo "build_matrix=$(yaml2json '${{ inputs.build_matrix_path }}' | jq -c .)" >> $GITHUB_ENV
          yaml2json "${{ inputs.build_matrix_path }}" | jq

  prepare_files:
    needs: [create-qwerty-keymap, fetch-build-matrix]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    env:
      CONFIG_PATH: "config"
      KEYMAP_PATH: "config/boards/shields/charybdis-mini-wireless/keymaps"
      DEFAULT_KM_PATH: "config/boards/shields/charybdis-mini-wireless"
    steps:
      - name: Copy keymap to isolated temporary directory
        run: |
          # COPY FROM KEYMAP DIR TO CONFIG WHICH WILL BE COPIED TO THE FOLDER
          # MIGHT NEED TO REMOVE EXTRA keymap FILES
          # cp -R ${{ $CONFIG_PATH }}/* "${{ env.base_dir }}/${{ $CONFIG_PATH }}/"
          rm -rf ${{ $DEFAULT_KM_PATH }}/*.keymap
          cp -R ${{ $KEYMAP_PATH }}/${{ matrix.keymap }}.keymap \
            "${{ $DEFAULT_KM_PATH }}/charybdis.keymap"

  build:
    name: Run default ZMK build workflow
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@main

    merge:
      runs-on: ubuntu-latest
      needs: build
      name: Merge Output Artifacts
      steps:
        - name: Merge QWERTY Artifacts
          uses: actions/upload-artifact/merge@v4
          with:
            name: "qwerty-firmware"
            pattern: artifact-charybdis_QWERTY*
            delete-merged: true
        - name: Merge Colemak DH Artifacts
          uses: actions/upload-artifact/merge@v4
          with:
            name: "colemak-dh-firmware"
            pattern: artifact-charybdis_colemak*
          delete-merged: true
# on: [push, pull_request, workflow_dispatch]

# jobs:
#   create-qwerty-keymap:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: "3.x"

#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           # Add any dependencies here

#       - name: Generate QWERTY keymap
#         run: |
#           python scripts/generate_qwerty.py

#   build:
#     needs: create-qwerty-keymap
#     uses: ./.github/workflows/user_config_build.yaml
#     # uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@main

